#! /usr/bin/env bash
#
# Wrapper script around the actual Bro invocation. 
#
# run-bro <pin_cpu> <Bro args>

. `dirname $0`/broctl-config.sh

pin_cpu=$1
shift

export PATH=${bindir}:${scriptsdir}:$PATH

use_installed_policies=1
source ${scriptsdir}/set-bro-path

if test `uname` == "FreeBSD" && uname -r | grep -q "^[456]"; then
   export MALLOC_OPTIONS="HR" # Helps performance on FreeBSD < 7
fi

child=""

trap sig_handler 0

function sig_handler
{
    if [ "$child" != "" ]; then
        kill -15 $child 2>/dev/null
        echo KILLED 1>&2
    fi;

    if [ ! -e .pid ]; then
       echo -1 >.pid
    fi
}

LIMIT=${memlimit:-1572864}
ulimit -m $LIMIT
ulimit -d $LIMIT
ulimit -v $LIMIT
ulimit -c unlimited

# show current limits (visible in crash reports and "broctl diag")
ulimit -m -d -v -c

echo "PATH=${PATH}" >.env_vars
echo "BROPATH=${BROPATH}" >>.env_vars
echo "CLUSTER_NODE=${CLUSTER_NODE}" >>.env_vars
echo $@ >.cmdline

date +%s >.startup
date >>.startup
date +%y-%m-%d_%H.%M.%S >>.startup # Bro default format when rotating files. 

mybro=${bro}
if [ "${havenfs}" -ne 0 ]; then
    mybro=${tmpexecdir}/`basename ${bro}`
    rm -f $mybro
    cp -p ${bro} $mybro
fi

sleep 1

if [ -n "${pin_command}" -a $pin_cpu -ge 0 ]; then
    # Test if the specified pin_command works, and if not, then output a more
    # useful error message (but let the pin_command output its own error
    # message just in case there's some other reason for the failure).
    true
    if [ $? -eq 0 ]; then
        ${pin_command} $pin_cpu true
        if [ $? -ne 0 ]; then
            echo "Error: possibly invalid CPU number $pin_cpu given for pin_cpus option" >&2
            exit
        fi
    fi

    nohup ${pin_command} $pin_cpu $mybro "$@" &
else
    nohup $mybro "$@" &
fi

child=$!

echo $child >.pid
wait $child
child=""
